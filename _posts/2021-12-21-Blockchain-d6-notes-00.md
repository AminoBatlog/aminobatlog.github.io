---
title: 区块链笔记 GHOST
key: blockchain20211221
tags:
  Blockchain
  ETH
---

区块链笔记6:

GHOST协议

笔记记录来源B站[北京大学肖臻老师《区块链技术与应用》公开课]https://www.bilibili.com/video/BV1Vt411X7JF

<!--more-->

---

>  共识机制Ghost协议

ETH出块比较快, 可能有的区块发布之后来不及广播到其他节点

而且如果有两个节点同时发布新的区块, 就会导致临时性的分叉, 而这种分叉在ETH上是常态

在BTC中, 因为出块时间较长, 临时性分叉的情况较少, 所以碰到orphan/stale block可以直接抛弃. 但是ETH中分叉情况很常见, 如果依旧按照BTC的方式处理, 就会导致经常性的挖到orphan block, 直接抛弃不公平

而且ETH和BTC一样, 都有矿池的出现, 这样导致

![img](/assets/images/2021-12-21/mining centralization.png)

如图, 如果矿池与个体矿工同时挖到了合法区块, 因为矿池所拥有的算力比个体矿工强, 所以矿池更有概率能挖出下一个合法区块从而成为最长合法链, 个体矿工只能期待有人能顺着他们挖出来的区块继续挖来打败矿池, 但是对于其他节点来说, 没有理由说一定要帮个体矿工继续挖, 就会导致挖矿中心化, 矿池永远能挖到合法区块, 而个体矿工挖的永远是孤儿区块

这种情况叫做centralization bias, 就是中心化带来不成比例的优势



于是就有了GHOST协议, 当你挖出来的区块作废的时候, 给你一些奖励, 这些废弃的区块, 在ETH里不叫作孤儿区块, 叫做uncle block

**这是最初版本的GHOST协议**

![img](/assets/images/2021-12-21/uncle block.png)

意思是对于当前区块来说, 这个uncle block是和当前区块的parent block一个辈分的

当前区块在发布的时候, 可以把叔父区块包含进来, 这样的话这个叔父区块能得到7/8的出块奖励

而包含叔父区块的那个当前区块, 可以额外得到1/32的出块奖励, 但是最多只能包含2个叔父区块

这个机制鼓励系统出现分叉的时候, 及时进行合并

缺点: 

1. 如果已经挖出了下一个区块, 才发现有叔父区块的存在的时候, 已经来不及了, 无法加入叔父区块
2. 如果有超过2个的叔父区块, 无法将所有的叔父区块加进来
3. 如果存在矿池间的竞争, 那有可能故意不把某个区块包括进来, 用比较小的损失换取竞争对手比较大的损失

于是需要更新GHOST协议:

如果当前区块没有包含叔父区块, 那么下一个区块, 或者更后面的区块也可以把这个叔父区块包含进来

![img](/assets/images/2021-12-21/updated uncle block.png)

但是如果没有规定迭代上限, 有人会去难度比较低的时候挖出很多个叔父区块, 从而期待被包含

![img](/assets/images/2021-12-21/generation limits.png)

如图, 越往前获得的收益越少, 再往前就已经没有收益了

所以必须是与当前区块7代以内有相同的祖先才算做叔父区块

优点:

1. 降低全节点的压力, 不需要维护太多的区块, 因为不用说追溯到很久以前的叔父区块
2. 因为分叉之后收益是随着区块越多递减的, 所以可以鼓励尽早合并叔父区块

这种合并只能针对state fork, 如果是发布了一个更新, 导致新节点不认老节点, 老节点不认新节点, 这属于硬分叉, 是无法通过ghost协议合并的

BTC发布的时候是得到两部分奖励, 一部分是block reward, 一部分是transaction fee, 区块奖励叫做静态奖励, 另一个叫动态奖励. 而对于ETH来说, 静态是block reward, 动态是gas fee

对于叔父区块来说, 他们能得到一定比例的block reward, 但是对于gas fee, 是得不到的. 但是问题不大, 因为gas fee所占的比例很小, 大部分都是block reward, 这个情况和BTC一样. 但是ETH不像BTC, 没有定期减半的说法

所以叔父区块的交易不被查证也不被执行, 叔父区块唯一需要被查的是该区块是否是一个合法发布的区块

叔父区块仅仅只认分叉的第一个区块, 不认在分叉的区块之后的其他区块, 因为这样会鼓励分叉攻击

![img](/assets/images/2021-12-21/uncle forking attack.png)

如果把叔父区块后续的区块也认作叔父区块给奖励的话, 那分叉攻击的代价大大降低了

所以仅仅只有第一个分叉区块有uncle reward, 后续的区块没有奖励

![img](/assets/images/2021-12-21/uncle sample.png)

如图#1, UncleNumber比Block Height少2, 就代表是第二代的叔父区块, 就会获得6/8的奖励, #2里少1, 那就是7/8的奖励, 以此类推

![img](/assets/images/2021-12-21/block sample.png)

在该图中左边的区块里:

倒数第二行的Uncles Rewards, 记录了包含了几个uncle

倒数第三行的Block Reward, 里, 记录了该区块所获得的的奖励, 首先是3个Ether是出块奖励, 第二部分0.16685开头的是gas fee, 第三部分是包含了uncle block之后获得的1/32出块奖励的奖励

