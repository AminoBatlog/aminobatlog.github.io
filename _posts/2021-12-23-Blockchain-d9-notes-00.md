---
title: 区块链笔记 theDAO
key: blockchain20211224
tags:
  Blockchain
  ETH
---

区块链笔记9:

theDAO

笔记记录来源B站[北京大学肖臻老师《区块链技术与应用》公开课]https://www.bilibili.com/video/BV1Vt411X7JF

<!--more-->

---

上节课讲了Re-entrancy Attack, 那么在ETH的历史上有一个赫赫有名的攻击, 这个攻击导致了ETH的分裂

既然BTC实现了去中心化交易, ETH实现了去中心化合约, 既然去中心化这么好, 为什么不把所有的东西去中心化呢? 于是就有了DAO的概念Decentralized Autonomous Organization

2015年出现了一个致力于众筹投资的DAO, 叫做theDAO

如果想参与theDAO, 发ether发给这个智能合约, 可以换回theDAO的代理的, 投资哪个项目的话是投票决定了, 手头的ether越多, 权重越大, 最后有收益的时候也是按照规章制度分配

这个工作方法有点像是DAC: Decentralized Autonomous Corporation

一般区别就是DAC是处于盈利目的的, DAO可以是非盈利的

theDAO的问题在于, 一开始钱用来投票投资, 那怎么取回来呢, theDAO里用的是拆分基金的方式, split DAO.  这个拆分的方法也不是单纯用于取回钱, 而是创建一个子基金child DAO.

child DAO的作用是, 如果有些人的投资理念不一样, 比如有个小项目觉得不错, 但是大部分人并不想投, 那么就可以拆分出来成为一个child DAO, 拆分的时候手中的代币是要收回去的, 然后换成相应的ether. 

拆分的极端的例子, 就是单独一个人成立一个子基金, 然后投资给自己. **这也是投资者取回资金的唯一方式**

在拆分之前有7天的讨论期, 成立之后有28天的锁定期, 就是打进去的ether要锁28天

理念没有错, 但是问题出现在了splitDAO的代码上

![img](/assets/images/2021-12-24/split DAO code.png)

这个函数中间, 先把钱还给调用的人, 然后再把theDAO中的总金额减少相应的数量, 再把调用者的账户清零

所以黑客利用了这个漏洞进行了重入攻击

当时众筹了1.5亿美元的ether, 结果被黑客卷走了5000万美元的ether, 这件事也引起了ETH大跳水

当时ETH的社区引发了讨论, 有人认为利用这28天锁定期回滚交易, 另一派认为不需要才去补救措施, 因为黑客的行为并没有违法, 因为code is law, 所以漏洞也是一部分

社区有人认为theDAO属于too big to fail, 所以是需要拯救的

那么补救的方法, 首先可以选择在出现问题的区块的前一个区块开始分叉

![img](/assets/images/2021-12-24/forking.png)

这样的补救措施的后果就是, 不仅是被攻击的交易回滚了, 很多其他合法的交易也被回滚了

theDAO仅仅只是一个智能合约, 还有很多其他的交易

所以是不行的

ETH社区制定了两步走策略:

1. 锁定黑客账户
2. 逐步退回相应的交易

所以首先发布了一个更新, 涉及到theDAO的账户, 不能进行任何交易

但是有个bug, **当判断这个交易和theDAO相关不予执行之后, 还需不需要收取汽油费?**

应该要, 不然会不断发起交易, 扰乱社区. 但是这个更新之后, 并没有收取汽油费, 结果出现了大量的DDoS Attack. 导致升级后的矿工总是收到这样的攻击, 只能回滚版本了

这个软分叉分案失败了, 于是使用了一个硬分叉方法, 把所有设计到theDAO的账户资金强行转到一个智能合约上, 而那个智能合约的唯一功能, 就是退钱

挖到第192w个区块的时候, 自动执行转账交易, 无所谓有没有合法签名. 所以旧矿工不认, 是个硬分叉

社区有人不干了, 开发团队随便发布一个新的功能就能强行转账, 那就不是去中心化的了

于是进行了投票, 结果就是大部分人支持硬分叉

但是其实有很多人并没有参与投票, 而且ETH上参与theDAO的人仅仅只是一部分, 对于其他人来说, 他们想不想回滚和他们无所谓, 而且大家上新链之后, 旧链的总算力大幅度下降, 同时难度也大幅度下降, 所以还是有矿工愿意在旧链上挖

于是乎, 过段时间有的交易所上线了旧链的币, 叫做ETC, 而新链继承了ETH这个名字, 依旧叫做ETH

但是如果只是单独的分开两条链, 会导致重放攻击, 所以后来给两个链都加了chainid